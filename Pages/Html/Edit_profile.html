<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile</title>
<link rel="stylesheet" href="../Css/Edit_profile.css">
</head>
<body>

<div class="profile-container">
  <h2>Edit Profile</h2>

  <form class="profile-form" onsubmit="updateProfile(event)">
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="username" placeholder="Enter name">
    </div>

    <div class="form-group">
      <label>Phone</label>
      <input type="tel" id="mobile_number" placeholder="Enter phone">
    </div>

    <div class="form-group">
      <label>Location</label>
      <input type="text" id="location" placeholder="Enter location">
    </div>

    <div class="form-group">
      <label>Profile Photo</label>
      <input type="file" id="profile_image" accept="image/*">
    </div>

    <button class="save-btn" type="submit">Save Changes</button>
    <p id="message" style="text-align:center;color:red;"></p>
  </form>
</div>

<script>
async function updateProfile(event) {
  event.preventDefault();

  const message = document.getElementById("message");
  message.innerText = "";

  const userId = localStorage.getItem("user_id");
  if (!userId) {
    message.innerText = "Please login again";
    return;
  }

  const username = document.getElementById("username").value.trim();
  const location = document.getElementById("location").value.trim();
  const mobileVal = document.getElementById("mobile_number").value.trim();
  const imageInput = document.getElementById("profile_image");

  /* ===============================
     1️⃣ UPLOAD IMAGE (CLOUDINARY)
     =============================== */
  if (imageInput.files.length > 0) {
    const formData = new FormData();
    formData.append("file", imageInput.files[0]);

    const imgRes = await fetch(
      `http://localhost:8000/users/${userId}/upload-profile-image`,
      {
        method: "POST",
        body: formData
      }
    );

    const imgData = await imgRes.json();

    if (!imgRes.ok) {
      message.innerText = imgData.detail || "Image upload failed";
      return;
    }
  }

  /* ===============================
     2️⃣ UPDATE TEXT DETAILS
     =============================== */
  const payload = {};
  if (username) payload.username = username;
  if (location) payload.location = location;
  if (mobileVal) payload.mobile_number = Number(mobileVal);

  if (Object.keys(payload).length === 0 && imageInput.files.length === 0) {
    message.innerText = "No changes to update";
    return;
  }

  if (Object.keys(payload).length > 0) {
    const res = await fetch(
      `http://localhost:8000/users/${userId}/profile`,
      {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    const data = await res.json();
    if (!res.ok) {
      message.innerText = data.detail || "Update failed";
      return;
    }
  }

  message.style.color = "green";
  message.innerText = "Profile updated successfully";

  setTimeout(() => {
    window.location.href = "./profile.html";
  }, 800);
}
</script>

</body>
</html>
