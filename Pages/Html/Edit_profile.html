<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile ‚Äî PadPick</title>
<link rel="icon" href="/Asset/Screenshot_2026-02-10_215817-removebg-preview.png" type="image/x-icon">
<link rel="stylesheet" href="../Css/Edit_profile.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

</head>

<body>

<a class="back-link" href="./profile.html">
  <div class="back-arrow">‚Üê</div>
  Back to Profile
</a>

<div class="profile-container">

  <div class="card-top">
    <div class="edit-icon">‚úèÔ∏è</div>
    <h2>Edit Profile</h2>
    <p>Update your personal information below</p>
  </div>

  <form class="profile-form" id="profileForm">

    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="username" placeholder="Enter your full name">
    </div>

    <div class="form-group">
      <label>Phone</label>
      <input type="tel" id="mobile_number" placeholder="Enter your phone number">
    </div>

    <div class="form-group">
      <label>Location</label>
      <input type="text" id="location" placeholder="Enter your city or area">
    </div>

    <div class="form-group">
      <label>Profile Photo</label>
      <label class="file-label" for="profile_image">
        <div class="file-icon">üñºÔ∏è</div>
        <div class="file-text">
          <span>Choose a photo</span>
          <small>JPG, PNG or WEBP ‚Äî max 5MB</small>
        </div>
      </label>
      <input type="file" id="profile_image" accept="image/*">
    </div>

    <hr class="divider">

    <button class="save-btn" type="submit" id="saveBtn">
      Save Changes
    </button>

    <p id="message"></p>

  </form>
</div>

<script>
const form = document.getElementById("profileForm");
const saveBtn = document.getElementById("saveBtn");
const message = document.getElementById("message");

form.addEventListener("submit", async (event) => {
  event.preventDefault();

  message.innerText = "";
  message.style.color = "red";

  const userId = localStorage.getItem("user_id");
  if (!userId) {
    message.innerText = "Please login again";
    return;
  }

  // üîí disable + loading
  saveBtn.disabled = true;
  saveBtn.innerText = "Saving...";
  saveBtn.style.opacity = "0.7";
  saveBtn.style.cursor = "not-allowed";

  try {
    const username = document.getElementById("username").value.trim();
    const location = document.getElementById("location").value.trim();
    const mobileVal = document.getElementById("mobile_number").value.trim();
    const imageInput = document.getElementById("profile_image");

    /* ===============================
       1Ô∏è‚É£ UPLOAD IMAGE
       =============================== */
    if (imageInput.files.length > 0) {
      const formData = new FormData();
      formData.append("file", imageInput.files[0]);

      const imgRes = await fetch(
        `https://padpick-backend.vercel.app/users/${userId}/upload-profile-image`,
        {
          method: "POST",
          body: formData
        }
      );

      const imgData = await imgRes.json();
      if (!imgRes.ok) {
        throw new Error(imgData.detail || "Image upload failed");
      }
    }

    /* ===============================
       2Ô∏è‚É£ UPDATE TEXT DETAILS
       =============================== */
    const payload = {};
    if (username) payload.username = username;
    if (location) payload.location = location;
    if (mobileVal) payload.mobile_number = Number(mobileVal);

    if (Object.keys(payload).length > 0) {
      const res = await fetch(
        `https://padpick-backend.vercel.app/users/${userId}/profile`,
        {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }
      );

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.detail || "Update failed");
      }
    }

    if (
      Object.keys(payload).length === 0 &&
      imageInput.files.length === 0
    ) {
      throw new Error("No changes to update");
    }

    message.style.color = "green";
    message.innerText = "Profile updated successfully ‚úÖ";

    setTimeout(() => {
      window.location.href = "./profile.html";
    }, 800);

  } catch (error) {
    console.error(error);
    message.innerText = error.message || "Something went wrong";
    resetButton();
  }
});

function resetButton() {
  saveBtn.disabled = false;
  saveBtn.innerText = "Save Changes";
  saveBtn.style.opacity = "1";
  saveBtn.style.cursor = "pointer";
}

// Show selected filename in file input label
document.getElementById("profile_image").addEventListener("change", function () {
  const fileText = this.closest(".form-group").querySelector(".file-text span");
  if (this.files.length > 0) {
    fileText.textContent = this.files[0].name;
  } else {
    fileText.textContent = "Choose a photo";
  }
});
</script>

</body>
</html>